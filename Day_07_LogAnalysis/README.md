# Day_07 [Log-Analysis] â€˜Tis the season for log chopping!

+ Deployable Machine: Yes

Description: To take revenge for the company demoting him to regional manager during the acquisition, Tracy McGreedy installed the CrypTOYminer, a malware he downloaded from the dark web, on all workstations and servers. Even more worrying and unknown to McGreedy, this malware includes a data-stealing functionality, which the malware author benefits from! The malware has been executed, and now, a lot of unusual traffic is being generated. What's more, a large bandwidth of data is seen to be leaving the network. Forensic McBlue assembles a team to analyse the proxy logs and understand the suspicious network traffic.

> IP: [10.10.108.77]

## LEARNING OBJECTIVES

1. Revisiting log files and their importance.
2. Understanding what a proxy is and breaking down the contents of a proxy log.
3. Building Linux command-line skills to parse log entries manually.
4. Analysing a proxy log based on typical use cases.

## OVERVIEW

1. What Is a Proxy Server
   1. A proxy server is an intermediary between your computer or device and the internet. When you request information or access a web page, your device connects to the proxy server instead of connecting directly to the target server. The proxy server then forwards your request to the internet, receives the response, and sends it back to your device. To visualise this, refer to the diagram below.

## IMPORTANT INFO

1. Log McBlue tells us that he has configured the Squid proxy server to use the following log format:
   1. `timestamp - source_ip - domain:port - http_method - http_uri - status_code - response_size - user_agent`

## STEPS

1. Deploy Machine
2. Open Split-Pane-View (Have to access the log file from the remote machine provided)
3. Based on the format McBlue set up we can see the position of data as:

   | Posistion           | Field           | Value                                        |
   |---------------------|-----------------|----------------------------------------------|
   | 1                   | Timestamp       | [2023/10/25:16:17:14]                        |
   | 2                   | Source IP       | 10.10.140.96                                 |
   | 3                   | Domain and Port | storage.live.com:443                         |
   | 4                   | HTTP Method     | GET                                          |
   | 5                   | HTTP URI        | /                                            |
   | 6                   | Status Code     | 400                                          |
   | 7                   | Response Size   | 630                                          |
   | 8                   | User Agent      | "Mozilla/5.0 (Windows NT 10.0; Win64; x64)...|

   1. Since we have data posisitions we now know how we can cut / parse the data
   2. We will use the `cut` command with `-d` to specify the columns of data
4. DATA COLLECTION
   1. IP
      1. > cut -d ' ' -f2 access.log | sort | uniq -c | sort
         1. In here we see `9` unique IP Addresses
            1. *NOTE: We can use the wc -l to get the number without physically counting*
   2. DOMAINS
      1. > cut -d ' ' -f3 access.log | cut -d ':' -f1 | sort | uniq -c | sort | wc -l
         1. `111`
   3. STATUS CODE
      1. > cut -d ' ' -f3 access.log | cut -d ':' -f1 | sort | uniq -c | sort
         1. In here we see that `partnerservices.getmicrosoftkey.com` is the least accessed domain
      2. > cut -d ' ' -f6 | grep partnerservices
         1. `503`
   4. SUSPICIOUS DOMAIN
      1. > cut -d ' ' -f3 access.log | cut -d ':' -f1 | sort | uniq -c | sort
         1. In here we see that at the end of the list there is `1581 frostlings.bigbadstash.thm`
   5. MALICIOUS SOURCE IP
      1. > cut -d ' ' -f2,3 access.log | sort | uniq -c | grep frostlings
         1. `1581 10.10.185.225 frostlings.bigbadstash.thm:80`
         2. IP = `10.10.185.225`
         3. REQ_COUNT = `1581`
   6. EXFILTRATED DATA
      1. > grep frostling access.log | cut -d ' ' -f5
         1. `/storage.php?goodies=bGFuZSBNb2RlbCBLaXQK`
         2. We get several responses all that start with "/storage.php?goodies=" followed by what looks like base64
      2. > grep frostling access.log | cut -d ' ' -f5 | cut '=' -f2
         1. This gives us each line in bas64 so lets decode this
      3. > grep frostling access.log | cut -d ' ' -f5 | cut '=' -f2 | base64 -d
         1. Scrolling through we see `72703959c91cb18edbefedc692c45204,SOC Analyst,THM{a_gift_for_you_awesome_analyst!}`
         2. FLAG: `THM{a_gift_for_you_awesome_analyst!}`


## QUESTIONS

1. How many unique IP addresses are connected to the proxy server?
   1. `9`
2. How many unique domains were accessed by all workstations?
   1. `111`
3. What status code is generated by the HTTP requests to the least accessed domain?
   1. `503`
4. Based on the high count of connection attempts, what is the name of the suspicious domain?
   1. `frostlings.bigbadstash.thm`
5. What is the source IP of the workstation that accessed the malicious domain?
   1. `10.10.185.225`
6. How many requests were made on the malicious domain in total?
   1. `1581`
7. Having retrieved the exfiltrated data, what is the hidden flag?
   1. `THM{a_gift_for_you_awesome_analyst!}`
